# C++实现邮件发送：基于 curl 库的 Email 模块封装

在自动化脚本和各类应用程序中，发送邮件是一个非常常见的需求。我们可以通过使用 [**`curl`**](https://github.com/curl/curl) 库，在C++中高效地实现邮件发送功能，满足多种实际场景的需求。

> [!TIP]
> **`curl`** 是一个功能强大的开源库，广泛用于在各种编程语言中进行网络通信。它不仅支持`HTTP/HTTPS`，还支持`FTP` 、`SMTP`、`POP3`等几乎所有网络协议。由于其稳定性和丰富的功能，**`curl`** 被许多知名项目和企业广泛采用，是网络编程领域的“瑞士军刀”。

## 前言

在介绍如何使用 `curl` 发送邮件之前，我们先了解一下邮件的本质以及相关协议。

我们可以将一封电子邮件看作是具有特定格式的文本数据，其中包含发件人、收件人、主题、正文、附件等信息。
而邮件的发送和接收依赖于`SMTP`（简单邮件传输协议）和`POP3`/`IMAP`等协议。

> [!IMPORTANT]
> 在发送邮件的过程中，我们主要关注的是 `SMTP` 协议，因为它负责邮件的投递。而 `POP3` 和 `IMAP` 协议则用于接收和管理邮件。对于只需要发送邮件的场景（如自动通知、报警等），通常无需关心 `POP3` 或 `IMAP` 协议。只有在需要从服务器读取或管理邮件时，才会涉及到这两个协议。
>
> **我们本节内容只关注邮件的发送部分，所以只关注 `SMTP` 协议。**

邮件发送需要邮件服务器，邮件接收需要邮件客户端。

通常对于普通个人用户，不管是邮件服务器还是邮件客户端，都是由**邮箱服务商**提供的。例如`QQ`邮箱、`Gmail`等。

> [!NOTE]
> 例如我们使用 QQ 邮箱发送邮件，那么 QQ 邮箱就是我们的邮件服务商。它提供了邮件服务器和客户端。我们发送邮件时，实际上是通过 QQ 邮箱的服务器来发送的。而对方收到邮件时，也是通过邮箱的服务器（不一定是 QQ 邮箱的服务器）来接收的。

而一些企业邮箱，则是他们自己搭建的。

无论是使用个人邮箱服务商还是自建的企业邮箱服务器，最终邮件的发送都是通过 `SMTP` 协议完成的。后面我们将介绍如何使用 C++ 和 `curl` 库来实现这一过程。

## 发送邮件的基本流程

发送邮件通常包含以下几个步骤：

1. **连接邮件服务器**：通过 `SMTP` 协议连接到发送方的邮件服务器（如 `smtp.qq.com`）。
2. **身份验证**：大多数邮箱服务商要求使用账号密码或授权码进行身份验证。例如，`QQ` 邮箱 和 `Gmail` 都要求使用**授权码**代替原始密码，以增强安全性。
3. **构建并发送邮件**：准备邮件内容（包括发件人、收件人、主题、正文、附件等），通过 SMTP 协议发送出去。
4. **关闭连接**：发送完成后，关闭与邮件服务器的连接，释放资源。

通常我们会选择一个固定的 SMTP 服务器，例如 `smtp.qq.com`，并将发件人设置为我们的 `QQ` 邮箱账号。而**收件人则可以是任意邮箱地址**，如 `Gmail`、`163` 邮箱等，这不受限制。

这是因为邮件的发送和转发由 SMTP 协议负责，它会将邮件从发送方服务器中继转发到接收方所对应的邮件服务器。只要接收方邮箱地址有效，SMTP 服务就能尝试投递。因此，发送方和接收方可以使用不同的邮箱服务商，互不影响。

## 使用 curl 发送邮件

我们使用 QQ 邮箱作为示例，在编写代码之前，我们需要先做一些准备工作。

1. 开启 `STMP` 服务与申请授权码。
2. 验证授权码有效，先使用 `curl` 命令行工具测试一下是否可以发送邮件。

端口设置见 [文档](https://service.mail.qq.com/detail/0/427)，通常为 `587`、`465`。

```bash
curl -v --url "smtp://smtp.qq.com:587" --ssl-reqd ^
--mail-from "Mq-b@qq.com" ^
--mail-rcpt "Mq-b@qq.com" ^
--upload-file .\测试邮件.txt ^
--user "Mq-b@qq.com:abcdefg" ^
--login-options "AUTH=LOGIN"
```

| 参数                                      | 说明                                                |
| --------------------------------------- | ------------------------------------------------- |
| `-v`                                    | 详细模式（verbose），打印调试信息，方便观察 SMTP 连接和交互过程            |
| `--url "smtp://smtp.qq.com:587"`        | 指定 SMTP 服务器地址和端口（587 是 SMTP 的 STARTTLS 端口）        |
| `--ssl-reqd`                            | 要求使用 TLS 加密（SMTP STARTTLS），确保传输安全                 |
| `--mail-from "Mq-b@qq.com"`             | 邮件发送者地址，即发件人邮箱                                    |
| `--mail-rcpt "Mq-b@qq.com"`             | 邮件接收者地址，即收件人邮箱（这里发给自己）                            |
| `--upload-file .\测试邮件.txt`              | 指定邮件内容文件，curl 会读取该文件内容作为邮件正文上传                    |
| `--user "Mq-b@qq.com:abcdefg"` | SMTP 登录用户名和授权码（密码）                                |
| `--login-options "AUTH=LOGIN"`          | 强制使用 SMTP `LOGIN` 认证方式，避免 curl 默认用 `PLAIN` 导致编码处理认证失败 |

>[!Tip]
>`curl` 命令行工具在不同平台表现略有差异，以上命令在 Windows 上使用时需要注意路径分隔符和编码处理。
>以上命令就是在 `windows cmd` 命令提示符中测试执行的。
>
>Linux 中 测试：
>
>```bash
>curl --url "smtp://smtp.qq.com:587" --ssl-reqd \
>  --mail-from "Mq-b@qq.com" --mail-rcpt "Mq-b@qq.com" \
>  --upload-file ./测试邮件.txt \
>  --user "Mq-b@qq.com:你的授权码" \
>  --login-options "AUTH=LOGIN"
>```

邮件文本 `测试邮件.txt` 内容：

```email
From: Test <Mq-b@qq.com>
To: Mq-b@qq.com
Subject: 测试邮件

这是一封使用curl发送的测试邮件。
```

| 邮件文本字段                             | 说明                                                           |
| ---------------------------------- | ------------------------------------------------------------ |
| `From: Test <Mq-b@qq.com>` | 发件人名字和邮箱地址，显示邮件是谁发的。`Test` 是显示名，`Mq-b@qq.com` 是发件邮箱。 |
| `To: Mq-b@qq.com`                  | 收件人邮箱地址，告诉邮件服务器邮件发给谁。                                        |
| `Subject: 测试邮件`                    | 邮件主题，收件人在邮箱客户端看到的标题。                                         |
| 空行                                 | 邮件头部和正文之间必须有一个空行，用来分隔。                                       |
| `这是一封使用curl发送的测试邮件。`               | 邮件正文内容，邮件的主要文本信息。                                            |

---

如果以上内容你都了解了，并且命令测试通过，那么前置也就完成了。下面我们开始编写 C++ 代码进行邮件发送。
